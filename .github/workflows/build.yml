name: Build Cross-Platform Apps

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/build.yml'
      - 'main.py'
      - 'requirements.txt'
      - 'logo.icns'  # ä»… macOS éœ€è¦ï¼Œä½†æ”¾åœ¨è¿™é‡Œä¾¿äºŽè§¦å‘

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            python-version: '3.9.9'
            architecture: 'x64'
            app-name: main_app
            icon: ''
          - os: macos-13
            python-version: '3.x'  # æˆ–æŒ‡å®šå¦‚ 3.9.9
            architecture: 'x64'
            app-name: HeyTeaAutoDraw
            icon: logo.icns

    permissions:
      contents: write  # ç”¨äºŽ macOS å‘å¸ƒ Release

    steps:
      - uses: actions/checkout@v4
        with:
          # macOS éœ€è¦æ˜¾å¼æŒ‡å®š x64 æž¶æž„ï¼ˆARM é»˜è®¤ï¼‰
          architecture: ${{ matrix.architecture }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.architecture }}

      - name: Install system dependencies (Windows only)
        if: matrix.os == 'windows-latest'
        run: |
          choco install -y vcredist2015
          pip install --upgrade pip setuptools wheel

      - name: Upgrade pip and install PyInstaller (macOS fallback)
        if: matrix.os == 'macos-13'
        run: |
          python -m pip install --upgrade pip setuptools wheel pyinstaller

      - name: Install project dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Verify logo.icns exists (macOS only)
        if: matrix.os == 'macos-13'
        run: |
          if [ ! -f logo.icns ]; then
            echo "âŒ Missing logo.icns in repository root!"
            exit 1
          fi
          echo "âœ… Found logo.icns"

      - name: Build executable
        run: |
          echo "=== Building for ${{ matrix.os }} ==="
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            python -m PyInstaller -F -n ${{ matrix.app-name }} --paths=./src main.py
          else
            python -m PyInstaller \
              --windowed \
              --name ${{ matrix.app-name }} \
              --clean \
              --noconfirm \
              --icon=${{ matrix.icon }} \
              --add-data='logo.icns:.' \
              main.py
          fi

      - name: Package as ZIP (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zipPath = "${{ runner.temp }}/build_artifact.zip"
          $files = @( "${{ github.workspace }}/dist/${{ matrix.app-name }}.exe" )
          Compress-Archive -Path $files -DestinationPath $zipPath -Force
          echo "zip_path=$zipPath" >> $env:GITHUB_ENV

      - name: Package as ZIP (macOS)
        if: matrix.os == 'macos-13'
        run: |
          cd dist
          zip -r ../${{ matrix.app-name }}-macOS-x86_64.zip ${{ matrix.app-name }}.app
          echo "zip_path=${{ github.workspace }}/${{ matrix.app-name }}-macOS-x86_64.zip" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-build
          path: ${{ env.zip_path }}

      - name: Create Release V1.0 and Upload Asset (macOS only)
        if: matrix.os == 'macos-13'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: V1.0
          name: macOS
          body: |
            ðŸ–¥ï¸ macOS x86_64 standalone application  
            Built on ${{ runner.os }} with Python ${{ matrix.python-version }}
          files: ${{ env.zip_path }}

      - name: Create summary
        run: |
          echo "### ðŸŽ‰ Build Successful on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python version: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- App name: ${{ matrix.app-name }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ”ï¸ Build completed" >> $GITHUB_STEP_SUMMARY
