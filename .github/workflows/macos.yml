name: Build macOS App and Publish to V1.0

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build-macos:
    runs-on: macos-13
    # ğŸ‘‡ å…³é”®ä¿®å¤ï¼šæˆäºˆåˆ›å»º Release æ‰€éœ€çš„å†™æƒé™
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          architecture: x64

      - name: Set up Python
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Verify logo.icns exists
        run: |
          if [ ! -f logo.icns ]; then
            echo "âŒ Missing logo.icns in repository root!"
            exit 1
          fi
          echo "âœ… Found logo.icns"

      - name: Build macOS .app
        run: |
          python -m PyInstaller \
            --windowed \
            --name HeyTeaAutoDraw \
            --clean \
            --noconfirm \
            --icon=logo.icns \
            --add-data='logo.icns:.' \
            main.py

      - name: Package as ZIP
        run: |
          cd dist
          zip -r HeyTeaAutoDraw-macOS-x86_64.zip HeyTeaAutoDraw.app

      - name: Create Release V1.0 and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: V1.0
          name: macOS
          body: |
            ğŸ–¥ï¸ macOS x86_64 standalone application  
            Built on ${{ runner.os }} with Python ${{ env.PYTHON_VERSION }}
          files: dist/HeyTeaAutoDraw-macOS-x86_64.zip
