name: macOS Build and Attach to Release V1.0

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/macos.yml'

jobs:
  pyinstaller-build:
    runs-on: macos-13
    env:
      TZ: Asia/Shanghai
      PYTHON_VERSION: "3.9.9"
      MACOSX_DEPLOYMENT_TARGET: "10.15"

    steps:
      - uses: actions/checkout@v4
        with:
          architecture: x64

      - name: Install x86_64 Python via pyenv
        run: |
          brew install openssl readline sqlite3 xz zlib tcl-tk
          brew install pyenv
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          source ~/.bashrc
          arch -x86_64 pyenv install $PYTHON_VERSION --verbose
          pyenv global $PYTHON_VERSION
          python -c "import platform; print('Python Arch:', platform.machine())"

      - name: Set up Python PATH
        run: |
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH
          echo "$HOME/.pyenv/bin" >> $GITHUB_PATH

      - name: Verify Python
        run: |
          python --version
          pip --version
          python -c "import platform; print(platform.machine())"

      - name: Install build tools and icnsutil
        run: |
          pip install --upgrade pip setuptools wheel
          pip install pyinstaller icnsutil
          pip install -r requirements.txt

      - name: Generate logo.icns from logo.png
        run: python -c "from icnsutil import IcnsFile; IcnsFile.from_png('logo.png').write('logo.icns'); print('âœ… Generated logo.icns')"

      - name: Build macOS .app bundle
        run: |
          rm -rf __pycache__ build dist
          
          python -m PyInstaller \
            --windowed \
            --name main_app \
            --clean \
            --noconfirm \
            --paths=./src \
            --icon=logo.icns \
            --add-data="logo.png:." \
            --exclude-module=pytest \
            --exclude-module=unittest \
            --exclude-module=doctest \
            --exclude-module=jupyter \
            --exclude-module=IPython \
            main.py

          BINARY="dist/main_app.app/Contents/MacOS/main_app"
          file "$BINARY"
          lipo -archs "$BINARY"

      - name: Prepare macOS artifact ZIP
        run: |
          mkdir -p dist/macos_bundle
          cp -r dist/main_app.app dist/macos_bundle/
          cd dist && zip -r HeyTeaAutoDraw-macOS-x86_64.zip macos_bundle/

      - name: Upload to Release V1.0 (append, not replace!)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: V1.0
          files: dist/HeyTeaAutoDraw-macOS-x86_64.zip
          append: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          BINARY="dist/main_app.app/Contents/MacOS/main_app"
          echo "### ðŸ–¥ï¸ macOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture: $(lipo -archs "$BINARY")" >> $GITHUB_STEP_SUMMARY
          echo "- Binary size: $(du -h "$BINARY" | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- Uploaded to Release **V1.0** as additional asset." >> $GITHUB_STEP_SUMMARY
