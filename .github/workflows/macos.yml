name: macOS
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/macos.yml'

jobs:
  pyinstaller-build:
    runs-on: macos-13
    strategy:
      matrix:
        node-version: [ 12.x ]
    env:
      TZ: Asia/Shanghai
      PYTHON_VERSION: "3.9.9"
      MACOSX_DEPLOYMENT_TARGET: "10.15"

    steps:
      - uses: actions/checkout@v4
        with:
          architecture: x64

      - name: Install x86_64 Python via pyenv
        run: |
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          brew install openssl readline sqlite3 xz zlib tcl-tk
          
          # å®‰è£… pyenv
          brew install pyenv
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          source ~/.bashrc
          
          # å¼ºåˆ¶å®‰è£… x86_64 ç‰ˆæœ¬ Python
          arch -x86_64 pyenv install $PYTHON_VERSION --verbose
          pyenv global $PYTHON_VERSION
          
          # éªŒè¯æž¶æž„
          python -c "import platform; print('Python Arch:', platform.machine())"
          which python

      - name: Set up Python PATH
        run: |
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH
          echo "$HOME/.pyenv/bin" >> $GITHUB_PATH

      - name: Verify Python
        run: |
          python --version
          pip --version
          python -c "import platform; print(platform.machine())"

      - name: Install build tools
        run: |
          pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build executable
        run: |
          # å®Œå…¨æ¸…ç†çŽ¯å¢ƒ
          rm -rf __pycache__ build dist
          
          # ä½¿ç”¨ç›®å½•æ‰“åŒ…ç”Ÿæˆ.appæ–‡ä»¶ï¼Œ--windowedé€‰é¡¹ä¼šè‡ªåŠ¨åˆ›å»º.appåŒ…
          python -m PyInstaller \
            --windowed \
            --name main_app \
            --clean \
            --noconfirm \
            --paths=./src \
            --icon=logo.png \
            --add-data="logo.png:." \
            --exclude-module=pytest \
            --exclude-module=unittest \
            --exclude-module=doctest \
            --exclude-module=jupyter \
            --exclude-module=IPython \
            main.py
          
          # éªŒè¯æž¶æž„
          file dist/main_app
          lipo -archs dist/main_app

      - name: Prepare artifacts
        run: |
          mkdir -p dist/macos_bundle
          # ç¡®ä¿å¤åˆ¶.appæ–‡ä»¶
          cp -r dist/main_app.app dist/macos_bundle/ 
          
          # åˆ›å»º ZIP åŒ…
          cd dist && zip -r macos_bundle.zip macos_bundle/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-build
          path: dist/macos_bundle.zip

      - name: Create summary
        run: |
          echo "### ðŸ–¥ï¸ macOS Build Report" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Binary Architecture: $(lipo -archs dist/main_app)" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(du -h dist/main_app | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          file dist/main_app >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
